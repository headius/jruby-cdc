#!/usr/bin/env jruby

require 'jruby'

runtime = JRuby.runtime

if ARGV.size < 1
  puts "Usage: jrubyc <filename.rb> [<filename.rb> ...]"
  exit
end

ARGV.each do |filename|
  unless File.exists? filename
    puts "Error -- file not found: #{filename}"
    next
  end
  
  begin
    file = File.open(filename)
    destdir = Dir.pwd
  
    BAIS = java.io.ByteArrayInputStream
    Mangler = org.jruby.util.JavaNameMangler
    BytecodeCompiler = org.jruby.compiler.impl.StandardASMCompiler
    ASTCompiler = org.jruby.compiler.ASTCompiler
    JavaFile = java.io.File
    
    inspector = org.jruby.compiler.ASTInspector.new
    
    source = file.read
    node = runtime.parse_file(BAIS.new(source.to_java_bytes), filename, nil)
    
    classpath = Mangler.mangle_filename_for_classpath(filename)
    
    inspector.inspect(node)
    
    compiler = BytecodeCompiler.new(classpath, filename)
    ASTCompiler.compile_root(node, compiler, inspector)
    
    compiler.write_class(JavaFile.new(destdir))
  rescue
    puts "Failure during compilation of file #{filename}:\n#{$!}"
  ensure
    file.close unless file.nil?
  end
end