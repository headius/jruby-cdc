$VERBOSE = true
$verbose = Rake.application.options.trace

require 'ffi'
require 'ffi/tools/const_generator'
require 'fileutils'

arches = [ ]
arch_options = {}

if JRuby::FFI::Platform::IS_MAC
  osx_arches = [ "ppc", "i386" ]
  osx_arches << "x86_64" if `arch` == "x86_64"
  osx_arches.each do |arch|
    arches << arch
    platform_dir = File.join("src/org/jruby/platform/darwin", "#{arch}")
    platform_pkg = "org.jruby.platform.darwin.#{arch}"
    arch_options[arch] = {
        :platform_osdir => File.join("src/org/jruby/platform", JRuby::FFI::Platform::OS),
        :platform_dir => platform_dir,
        :platform_pkg => platform_pkg,
        :cppflags => "-arch #{arch}"
    }
  end

else
  arches = [ JRuby::FFI::Platform::ARCH ]
  arch_options[JRuby::FFI::Platform::ARCH] = {
    :platform_osdir => File.join("src/org/jruby/platform", JRuby::FFI::Platform::OS),
    :platform_dir => File.join("src/org/jruby/platform", JRuby::FFI::Platform::OS, JRuby::FFI::Platform::ARCH),
    :platform_pkg => "org.jruby.platform.#{JRuby::FFI::Platform::OS}.#{JRuby::FFI::Platform::ARCH}",
    :cppflags => ""
    }
end

def gen_java_constants(name, pkg, dir, options = {})
  out_name = File.join(dir, "#{name}.java")
  meth = "gen_#{name.downcase}_java".to_sym
  FileUtils.makedirs(dir)
  File.open(out_name, "w") do |f|
    constants = send(meth, options).constants

    f.puts "// WARNING: This file is autogenerated. DO NOT EDIT!"
    f.puts "package #{pkg};"
    f.puts "public enum #{name} implements org.jruby.platform.IntConstant {";
    constants.values.each_with_index do |c, i|
      if c.value.nil?
        f.puts "// #{c.name} not defined"
      else
        f.puts "#{c.name}(#{c.converted_value})#{i < (constants.size - 1) ? ',' : ';'}"
      end
    end
    f.puts "private final int value;"
    f.puts "private #{name}(int value) { this.value = value; }"
    f.puts "public final int value() { return value; }"
    f.puts "}"
  end
end
const_tasks = []
[ "Errno" ].each do |name|
  load File.join(File.dirname(__FILE__), "#{name}.rake")
  task "gen_files_#{name}" do
    pkg = "org.jruby.platform.#{JRuby::FFI::Platform::OS}"
    dir = "src/org/jruby/platform/#{JRuby::FFI::Platform::OS}"
    gen_java_constants(name, pkg, dir)
  end
  const_tasks << "gen_files_#{name}"
end unless JRuby::FFI::Platform::IS_WINDOWS


task :default => :build
task :build => const_tasks