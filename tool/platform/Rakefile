$VERBOSE = true
$verbose = Rake.application.options.trace

require 'ffi'
require 'ffi/tools/const_generator'
require 'fileutils'

arches = [ ]
arch_options = {}

if JRuby::FFI::Platform::IS_MAC
  osx_arches = [ "ppc", "i386" ]
  osx_arches << "x86_64" if `arch` == "x86_64"
  osx_arches.each do |arch|
    arches << arch
    platform_dir = File.join("src/org/jruby/platform/darwin", "#{arch}")
    platform_pkg = "org.jruby.platform.darwin.#{arch}"
    arch_options[arch] = {
        :platform_dir => platform_dir,
        :platform_pkg => platform_pkg,
        :cppflags => "-arch #{arch}"
    }
  end

else
  arches = [ JRuby::FFI::Platform::ARCH ]
  arch_options[JRuby::FFI::Platform::ARCH] = {
    :platform_dir => File.join("src/org/jruby/platform", JRuby::FFI::Platform::OS, JRuby::FFI::Platform::ARCH),
    :platform_pkg => "org.jruby.platform.#{JRuby::FFI::Platform::OS}.#{JRuby::FFI::Platform::ARCH}",
    :cppflags => ""
    }
end
arch_files = []
[ "Errno" ].each do |name|
  load File.join(File.dirname(__FILE__), "#{name}.rake")
  arches.each do |arch|
    options = arch_options[arch]
    meth = "gen_#{name.downcase}_java".to_sym
    task "gen_files_#{arch}" do
      out_name = File.join(options[:platform_dir], "#{name}.java")
      pkg = options[:platform_pkg]
      File.open(out_name, "w") do |f|
        constants = send(meth, f).constants
        f.puts "// WARNING: This file is autogenerated. DO NOT EDIT!"
        f.puts "package #{pkg};"
        f.puts "public final class #{name} {";
        f.puts "private #{name}() {}"
        f.puts "public static final java.util.Map<String, Integer> CONSTANTS = java.util.Collections.unmodifiableMap(new java.util.HashMap<String, Integer>() {{"
        constants.each_value do |c|
          if c.value.nil?
            f.puts "// #{c.name} not defined"
          else
            f.puts %(put("#{c.name}", #{c.converted_value});)
          end
        end
        f.puts "}});"
        f.puts "}"
      end
    end
    arch_files << "gen_files_#{arch}"
  end
end unless JRuby::FFI::Platform::IS_WINDOWS


task :default => :build
task :build => arch_files